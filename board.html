<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>게시판</title>
</head>
<body>
  <a href="community.html">← 게시판 목록</a>
  <h1 id="board-title">게시판</h1>

  <!-- 글쓰기 폼 -->
  <form id="post-form">
    <input type="text" id="title" placeholder="제목" required />
    <textarea id="content" placeholder="내용" required></textarea>
    <input type="text" id="nickname" placeholder="닉네임 (선택)" />
    <button type="submit">글쓰기</button>
  </form>

  <div id="post-list"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const boardId = parseInt(params.get('board_id') || '0', 10);

    if (!boardId) {
      document.getElementById('post-list').innerText = '잘못된 게시판입니다.';
    } else {
      loadBoardInfo();
      loadPosts();
    }

    async function loadBoardInfo() {
      const { data, error } = await supa
        .from('boards')
        .select('name')
        .eq('id', boardId)
        .single();

      if (!error && data) {
        document.getElementById('board-title').innerText = data.name;
      }
    }

    async function loadPosts() {
      const box = document.getElementById('post-list');
      box.innerText = '글 불러오는 중...';

      const { data, error } = await supa
        .from('posts')
        .select('id, title, nickname, created_at, likes_count')
        .eq('board_id', boardId)
        .order('created_at', { ascending: false });

      if (error) {
        box.innerText = '에러: ' + error.message;
        return;
      }
      if (!data || data.length === 0) {
        box.innerText = '첫 글을 작성해 주세요.';
        return;
      }

      box.innerHTML = data.map(p => `
        <a href="post.html?id=${p.id}">
          ${p.title} / ${p.nickname || '익명'} / ${new Date(p.created_at).toLocaleString()} / ♥ ${p.likes_count}
        </a>
      `).join('<br>');
    }

    // 글쓰기 처리
    document.getElementById('post-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const nickname = document.getElementById('nickname').value.trim() || '익명';
      if (!title || !content) return;

      const { error } = await supa.from('posts').insert({
        board_id: boardId,
        title,
        content,
        nickname
      });

      if (error) {
        alert('글 작성 중 오류: ' + error.message);
        return;
      }

      e.target.reset();
      loadPosts(); // 목록 새로고침
    });
  </script>
</body>
</html>
