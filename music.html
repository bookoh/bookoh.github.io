<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>BSBKTV Music</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 16px;
      }
      ul { list-style: none; padding: 0; }
      li { margin-bottom: 8px; cursor: pointer; }
      li.playing { font-weight: bold; color: #d22; }
    </style>
  </head>
  <body>
    <header>
      <h1>뮤직</h1>
    </header>

    <section>
      <audio id="player" controls style="width:100%; margin-bottom:12px;"></audio>
      <ul id="music-list"></ul>
    </section>

    <script>
      const player = document.getElementById('player');
      const listEl = document.getElementById('music-list');
      let currentId = null;

      async function loadMusic() {
        const { data, error } = await db
          .from('music')          // Supabase 테이블 이름
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          console.error(error);
          listEl.textContent = '뮤직 불러오기 실패';
          return;
        }

        if (!data || data.length === 0) {
          listEl.textContent = '등록된 음악이 없습니다.';
          return;
        }

        listEl.innerHTML = '';
        data.forEach((track) => {
          const li = document.createElement('li');
          li.textContent = track.title || track.file_name || '무제';
          li.dataset.url = track.audio_url;   // audio_url 컬럼에 공개 URL 저장했다고 가정
          li.dataset.id = track.id;

          li.addEventListener('click', () => {
            playTrack(li.dataset.id, li.dataset.url);
          });

          listEl.appendChild(li);
        });
      }

      function playTrack(id, url) {
        if (!url) return;

        currentId = id;
        player.src = url;
        player.play();

        Array.from(listEl.children).forEach((li) => {
          li.classList.toggle('playing', li.dataset.id === String(id));
        });
      }

      loadMusic();
    </script>
  </body>
</html>
